extends layout
    
block content
  
  // Google Maps Mixin to Display Venue Location
  mixin google-map-place(query, key)
    - if ("alt" in attributes)
      - alt = attributes.alt;
      - delete attributes.alt;
    - else
      - alt = true;
    - if (query.length == 27 && query.indexOf(["+"]) < 1)
      - query = "place_id:" + query
    - else
      - query = query.replace(/ /g, "+");
    iframe(src=`https://google.com/maps/embed/v1/place?key=${key}&q=${query}`
           frameborder="0"
           width="90%"
           height="450")&attributes(attributes)
      - if (alt)
        | Your browser does not support iframes.
  - const gMapsKey = "AIzaSyDw04dJQyETFjfsthXJzhvjAiY9XE9Labc";
  
  //- Show Heading if Venue has been Deleted
  if (deleted)
    br
    h1 Venue successfully deleted.
  
  //- Regular Venue Profile
  else
    center
      - const imgURL = "https://studyspot.s3.amazonaws.com/venue/header/" + venue._id.toString() + ".jpg"
      img.venue-header(src = imgURL 
        onerror="this.src='https://studyspot.s3.amazonaws.com/venue/header/default.jpg'")
      
    br
    .row.venue-profile-page
        
      // Main Content Div
      div.col-lg-7.col-md-12.offset-lg-1.venue-info-div
      
        // Basic Information
        div
          h2 #{message}
          h2 #{venue.venueName}
          p #{venue.venueType} | #{venue.venueAddress.venueSuburb}, #{venue.venueAddress.venueState}
        
          if (user)
            
            - const id = venue._id
            - const imagePage = '/venueImage/' + id
            p 
              a(href=imagePage) Upload an image for this venue
            
            - const suggestionsPage = '/venueSuggestions/' + id
            p
              a(href=suggestionsPage) Suggest changes

              
          else
            p Please #[a(href="/login") log in] or #[a(href="/register") sign up] to suggest changes or upload images for this venue.
            
        // Venue Details
        div.venue-details-div
          h3 Details
                      
          table.venue-details-table
              
            // icons
            tr
                
              // type
              td
                if venue.venueType === "Cafe"
                  img.rounded(src="/images/venue/cafe.png", width="50px")
                else if venue.venueType === "Public Library"
                  img.rounded(src="/images/venue/library.png", width="50px")
                else
                  img.rounded(src="/images/venue/other.png", width="50px")
                
              // noise
              td
                if venue.venueDetails.noise === "low"
                  img.rounded(src="/images/venue/low.png", width="40px")
                else if venue.venueDetails.noise === "med"
                  img.rounded(src="/images/venue/med.png", width="40px")
                else
                  img.rounded(src="/images/venue/high.png", width="40px")
                
              // wifi
              td
                if venue.venueDetails.wifi
                  img.rounded(src="/images/venue/wifi.png", width="50px")
                else
                  img.rounded(src="/images/venue/nowifi.png", width="50px")
                
              // toilets
              td
                if venue.venueDetails.toilets
                  img.rounded(src="/images/venue/toilets.png", width="50px")
                else
                  img.rounded(src="/images/venue/notoilets.png", width="50px")
                  
              // powerpoints
              td
                if venue.venueDetails.power
                  img.rounded(src="/images/venue/power.png", width="50px")
                else
                  img.rounded(src="/images/venue/nopower.png", width="50px")
                      
              // discussion-friendly
              td
                if venue.venueDetails.discussionFriendly
                  img.rounded(src="/images/venue/discussion.png", width="50px")
                else
                  img.rounded(src="/images/venue/silence.png", width="50px")
                    
              // printer
              td
                if venue.venueDetails.printer
                  img.rounded(src="/images/venue/printer.png", width="50px")
                else
                  img.rounded(src="/images/venue/noprinter.png", width="50px")
               
            // labels
            tr
              //type
              td #{venue.venueType}  
              //noise
              td #{venue.venueDetails.noise} noise
              //wifi
              if venue.venueDetails.wifi
                td Wifi
              else
                td No wifi
              // toilets
              if venue.venueDetails.toilets
                td Toilets
              else
                td No toilets
              // powerpoints
              if venue.venueDetails.power
                td Powerpoints
              else
                td No powerpoints
              // discussion-friendly
              if venue.venueDetails.discussionFriendly
                td Discussion
                  p friendly
              else
                td Silent 
                  p space
              // printer
              if venue.venueDetails.printer
                td Printing
                  p available
              else
                td No printing 
                  p available
        
        br
        // Reviews
        div.venue-reviews
          h2 Reviews
          
          //- Create New Review
          //- If suggestion already submitted only show message
          if (completed)
            p Successfully added your review
            
            br
            h4 Your Review of #{venue.venueName}
            - newReviewDate = newReview.datePosted.toDateString()
            
            .col-10
              .card.mb-3
                
                .row
                    .col-2
                      p user profile image
                    .col-8
                      div
                        //insert user name
                        h5 #[a(href="/user/"+newReview.userId) #{newReview.userFirstName} #{newReview.userLastName}]
                      div
                        //- insert rating
                        p Rating: #{newReview.rating}/5
                      

                .offset-1
                  //- insert review text
                  p #{newReview.content}
                
                .offset-9
                  //- insert date
                  p #{newReviewDate}
          
          //- If user is not logged in
          if !(user)
            p Please #[a(href="/login") log in] or #[a(href="/register") sign up] to leave a review.
          
          else
            - var existingReview = false
            each review in venuesReviews
              if (user._id.toString() == review.userId.toString())
                - existingReview = true
               
                h4 Your Review of #{venue.venueName}
                - date = review.datePosted.toDateString()
                
                .col-10
                  .card.mb-3
                    
                    .row
                        .col-2
                          - const imgURL = "https://studyspot.s3.amazonaws.com/venue/header/" + review.userId.toString() + ".jpg"
                          img.venue-thumbnail(src = imgURL 
                            onerror="this.src='https://studyspot.s3.amazonaws.com/venue/header/default.jpg'")
                        .col-8
                          div
                            //insert user name
                            h5 #[a(href="/profile") #{review.userFirstName} #{review.userLastName}]
                          div
                            //- insert rating
                            p Rating: #{review.rating}/5
                        
                    .offset-1
                      //- insert review text
                      p #{review.content}
                    
                    .offset-9
                      //- insert date
                      p #{date}
                .row 
                  .offset-1.mb-3
                    
                    - const updateReview = "/review/update/" + review._id
                    a(href=updateReview) Edit Review  
                    
                    - const deleteReview = "/review/delete/" + review._id
                    a(href=deleteReview) Delete Review
              
          
            //- Else, show suggestion form
            if !(existingReview) && !(completed)
              div.bg-light.border.col-lg-10
                p Submit a review for <strong>#{venue.venueName} </strong>           

                form(method='POST' action='') 
                  
                  input.form-control(type="hidden" name='userId' value=user._id) 
                  
                  input.form-control(type="hidden" name='userFirstName' value=user.first_name) 
                  input.form-control(type="hidden" name='userLastName' value=user.last_name) 
              
                  input.form-control(type="hidden" name='venueId' value=venue._id)  
            
                
                  div.btn-group.btn-group-toggle(data-toggle="buttons")
                    label.btn.btn-outline-danger
                      input#option1(type="radio" name="star" value=1 autocomplete="off") 
                      |1 Star ★

                    label.btn.btn-outline-warning
                      input#option2(type="radio" name="star" value=2 autocomplete="off") 
                      |2 Stars ★
                    
                    label.btn.btn-outline-secondary
                      input#option3(type="radio" name="star" value=3 autocomplete="off") 
                      |3 Stars ★
                      
                    label.btn.btn-outline-info
                      input#option4(type="radio" name="star" value=4 autocomplete="off") 
                      |4 Stars ★
                      
                    label.btn.btn-outline-success
                      input#option5(type="radio" name="star" value=5 autocomplete="off") 
                      |5 Stars ★
                
                  //- Textbox
                  br
                  br
                  textarea.col-lg-11.form-control(rows="3" name="review" placeholder="Please enter review here.")
                  //- Submit 
                  br
                  button.btn.btn-primary(type="submit") Submit
              

          
          //- List reviews
          h4 Reviews from Other StudySpotters
          each review in venuesReviews

            if !(user) || (user._id.toString() != review.userId.toString())
              
              - date = review.datePosted.toDateString()
              .col-lg-10
                .card.mb-3
                  
                  .row
                    .col-2
                      - const imgURL = "https://studyspot.s3.amazonaws.com/venue/header/" + review.userId.toString() + ".jpg"
                      img.venue-thumbnail(src = imgURL 
                        onerror="this.src='https://studyspot.s3.amazonaws.com/venue/header/default.jpg'")
                    .col-10
                      div
                        //insert user name
                        h5 #[a(href="/user/"+review.userId) #{review.userFirstName} #{review.userLastName}]
                      div
                        //insert rating
                        p Rating: #{review.rating}/5
            
                  .offset-1
                    //insert review text
                    p #{review.content}
                  
                  .offset-9
                    //insert date
                    p #{date}
                  

      
      //- Side Bar
      div.col-lg-3.col-md-12.venue-side-bar
        
        //- Contacts
        if venue.venueContact.phone || venue.venueContact.mobile || venue.venueContact.email || venue.venueContact.web
          br
          h5 Contact Details
          if venue.venueContact.phone
            p phone: #{venue.venueContact.phonePrefix} #{venue.venueContact.phone}
          if venue.venueContact.mobile
            p mobile: #{venue.venueContact.mobilePrefix} #{venue.venueContact.mobile}
          if venue.venueContact.email
            p #{venue.venueContact.email}
          if venue.venueContact.web
            a(href=venue.venueContact.web) #{venue.venueContact.web}
        
        br
        
        //- Location
        h5 Location
        
        - const query = venue.venueAddress.venueStreetAddress + ", " + venue.venueAddress.venueSuburb
        +google-map-place(query, gMapsKey)(maptype="roadmap")
        
        p #{venue.venueAddress.venueStreetAddress}, 
          |#{venue.venueAddress.venueSuburb}, #{venue.venueAddress.venueState}, #{venue.venueAddress.venuePostcode}
        
        //- Opening hours
        h5 Opening Hours

        - const venueHours = venue.venueHours.toObject()
          each timeframe, day in venueHours
            p= day+ ": " + timeframe
    
    // Venue Update and Delete Buttons (Will be only available to users with admin attribute at later date)
    if (user && user.admin)
      .row
        .col-md-2.offset-1
          - const updateVenue = "/venueUpdate/" + venue._id
          a.btn.btn-Warning(href=updateVenue) UPDATE VENUE
        .col-md-2
          
          - const deleteVenue = "/deleteVenue/" + venue._id
          a.btn.btn-Danger(href=deleteVenue) DELETE VENUE
